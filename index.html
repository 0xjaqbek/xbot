<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitter Bot - GitHub Pages</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #1da1f2 0%, #0d8bd9 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(90deg, #1da1f2, #0d8bd9);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .auth-section {
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
        }

        .login-btn {
            background: #1da1f2;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .login-btn:hover {
            background: #0d8bd9;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(29, 161, 242, 0.3);
        }

        .main-content {
            display: none;
            grid-template-columns: 350px 1fr;
            min-height: 600px;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 30px;
            border-right: 1px solid #e9ecef;
        }

        .content-area {
            padding: 30px;
        }

        .user-info {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 15px;
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        input, textarea, button, select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #1da1f2;
        }

        button {
            background: #1da1f2;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #0d8bd9;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .post-item, .comment-item {
            padding: 20px;
            margin: 15px 0;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .post-item:hover, .comment-item:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transform: translateY(-3px);
        }

        .post-item.selected, .comment-item.selected {
            border-color: #1da1f2;
            background: #e3f2fd;
        }

        .post-meta, .comment-meta {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            display: flex;
            gap: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .response-area {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .response-buttons {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .response-buttons button {
            flex: 1;
        }

        .retry-btn {
            background: #ffc107;
            color: #000;
        }

        .retry-btn:hover {
            background: #e0a800;
        }

        .publish-btn {
            background: #28a745;
        }

        .publish-btn:hover {
            background: #218838;
        }

        .logout-btn {
            background: #dc3545;
            padding: 8px 16px;
            font-size: 12px;
            margin-top: 10px;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 18px;
            font-weight: bold;
            color: #1da1f2;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üê¶ Twitter Bot Assistant</h1>
            <p>AI-powered comment responses for your Twitter account</p>
        </div>

        <!-- Authentication Section -->
        <div id="authSection" class="auth-section">
            <h2>Connect Your Twitter Account</h2>
            <p style="margin: 20px 0; color: #666;">
                This tool helps you generate AI responses to comments on your tweets.<br>
                Your data is processed locally - no information is stored on servers.
            </p>
            <button id="loginBtn" class="login-btn" onclick="startTwitterAuth()">
                üîê Login with Twitter
            </button>
            <div style="margin-top: 30px;">
                <h3>üîë AI Configuration</h3>
                <input type="text" id="deepseekApiKey" placeholder="Enter your Deepseek API Key" style="max-width: 400px;" />
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    Get your free API key at <a href="https://platform.deepseek.com/" target="_blank">platform.deepseek.com</a>
                </p>
            </div>
            <div style="margin-top: 30px;">
                <h3>üîß Debug Tools</h3>
                <button onclick="showSetupInstructions()" style="background: #ffc107; color: #000; margin: 5px;">
                    üìã Setup Instructions
                </button>
                <button onclick="checkCurrentUrl()" style="background: #17a2b8; margin: 5px;">
                    üîç Check Current URL
                </button>
                <button onclick="testRedirect()" style="background: #28a745; margin: 5px;">
                    üß™ Test Redirect URI
                </button>
                <button onclick="enableCorsProxy()" style="background: #e74c3c; margin: 5px;">
                    üö´ Enable CORS Proxy
                </button>
                <button onclick="testProxy()" style="background: #9b59b6; margin: 5px;">
                    üîß Test API Endpoints
                </button>
            </div>
        </div>

        <!-- Main Application -->
        <div id="mainContent" class="main-content">
            <div class="sidebar">
                <!-- User Info -->
                <div id="userInfo" class="user-info">
                    <img id="userAvatar" src="" alt="User Avatar" class="user-avatar" />
                    <h3 id="userName">Loading...</h3>
                    <p id="userHandle">@loading</p>
                    <div class="stats">
                        <div class="stat">
                            <div id="followersCount" class="stat-number">-</div>
                            <div class="stat-label">Followers</div>
                        </div>
                        <div class="stat">
                            <div id="followingCount" class="stat-number">-</div>
                            <div class="stat-label">Following</div>
                        </div>
                        <div class="stat">
                            <div id="tweetsCount" class="stat-number">-</div>
                            <div class="stat-label">Tweets</div>
                        </div>
                    </div>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>

                <!-- AI Settings -->
                <div class="section">
                    <h3>ü§ñ AI Response Settings</h3>
                    <textarea id="responseInstructions" rows="4" placeholder="AI instructions...">You are a helpful and engaging social media assistant. Respond to comments in a friendly, professional manner that adds value to the conversation. Keep responses under 280 characters and maintain a positive tone.</textarea>
                    <select id="responseStyle">
                        <option value="professional">Professional</option>
                        <option value="casual">Casual & Friendly</option>
                        <option value="helpful">Helpful & Informative</option>
                        <option value="engaging">Engaging & Questions</option>
                    </select>
                </div>

                <!-- Actions -->
                <div class="section">
                    <h3>üìä Actions</h3>
                    <button onclick="loadMyTweets()">üîÑ Refresh My Tweets</button>
                    <button onclick="showAnalytics()">üìà View Analytics</button>
                </div>
            </div>

            <div class="content-area">
                <!-- My Tweets -->
                <div id="tweetsSection">
                    <h2>üìù Your Recent Tweets</h2>
                    <div id="tweetsContainer">
                        <p class="loading">Loading your tweets...</p>
                    </div>
                </div>

                <!-- Comments Section -->
                <div id="commentsSection" style="display: none;">
                    <h2>üí¨ Comments & Replies</h2>
                    <div id="commentsContainer"></div>
                </div>

                <!-- Response Generation -->
                <div id="responseSection" style="display: none;">
                    <h2>üéØ AI Generated Response</h2>
                    <div class="response-area">
                        <textarea id="generatedResponse" rows="4" placeholder="Generated response will appear here..."></textarea>
                        <div class="response-buttons">
                            <button class="retry-btn" onclick="generateResponse()">üîÑ Regenerate</button>
                            <button class="publish-btn" onclick="publishReply()">üì§ Post Reply</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CLIENT_ID = 'cGVLOGZSRERpNVhwM0JlUmxJaTE6MTpjaQ';
        const CLIENT_SECRET = 'A5FzUCko_Snr9NDOrn-nskwVgX_9aGDtFIZO_OR5czwL9SsySp';
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const USE_VERCEL_FUNCTION = true; // Set to true if you deploy to Vercel
        const VERCEL_FUNCTION_URL = '/api/twitter-token'; // Your Vercel function URL (corrected path)
        
        // Debug info
        console.log('üîó Current URL:', window.location.href);
        console.log('üîó Redirect URI:', REDIRECT_URI);
        console.log('üîë Client ID:', CLIENT_ID);
        console.log('üîê Client Secret:', CLIENT_SECRET ? 'Set' : 'Not set');
        console.log('‚ö° Use Vercel Function:', USE_VERCEL_FUNCTION);
        const DEEPSEEK_API_URL = 'https://api.deepseek.com/v1/chat/completions';

        // Global variables
        let accessToken = '';
        let deepseekApiKey = '';
        let currentUser = null;
        let selectedTweet = null;
        let selectedComment = null;

        // Check if user is returning from Twitter OAuth
        window.addEventListener('load', function() {
            console.log('üîç Page loaded, checking for OAuth callback...');
            console.log('üîó Current URL:', window.location.href);
            
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            const errorDescription = urlParams.get('error_description');

            console.log('üìã URL Parameters:');
            console.log('  - code:', code ? 'Present' : 'Missing');
            console.log('  - state:', state ? 'Present' : 'Missing');
            console.log('  - error:', error);
            console.log('  - error_description:', errorDescription);

            if (error) {
                console.error('‚ùå OAuth Error:', error, errorDescription);
                showError(`OAuth Error: ${error} - ${errorDescription}`);
                return;
            }

            if (code && state) {
                console.log('‚úÖ OAuth callback detected, processing...');
                handleOAuthCallback(code, state);
            } else {
                console.log('üìç No OAuth callback, checking for existing token...');
                // Check if user was previously authenticated
                accessToken = localStorage.getItem('twitter_access_token');
                if (accessToken) {
                    console.log('‚úÖ Found existing access token');
                    showMainApp();
                    loadUserInfo();
                } else {
                    console.log('üìç No existing token, showing login page');
                }
            }

            // Load saved API key
            deepseekApiKey = localStorage.getItem('deepseek_api_key') || '';
            if (deepseekApiKey) {
                document.getElementById('deepseekApiKey').value = deepseekApiKey;
            }
        });

        // Generate random string for OAuth state
        function generateRandomString(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Generate code challenge for PKCE
        async function generateCodeChallenge(codeVerifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        // Start Twitter OAuth flow
        async function startTwitterAuth() {
            // Save Deepseek API key
            const apiKey = document.getElementById('deepseekApiKey').value.trim();
            if (!apiKey) {
                showError('Please enter your Deepseek API key first');
                return;
            }
            deepseekApiKey = apiKey;
            localStorage.setItem('deepseek_api_key', deepseekApiKey);

            if (!CLIENT_ID || CLIENT_ID === 'YOUR_TWITTER_CLIENT_ID') {
                showSetupInstructions();
                return;
            }

            console.log('üöÄ Starting Twitter OAuth...');
            console.log('üîó Redirect URI that will be used:', REDIRECT_URI);

            // Generate PKCE parameters
            const codeVerifier = generateRandomString(128);
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            const state = generateRandomString(32);

            // Store PKCE parameters
            localStorage.setItem('pkce_code_verifier', codeVerifier);
            localStorage.setItem('oauth_state', state);

            // Build OAuth URL
            const params = new URLSearchParams({
                response_type: 'code',
                client_id: CLIENT_ID,
                redirect_uri: REDIRECT_URI,
                scope: 'tweet.read tweet.write users.read offline.access',
                state: state,
                code_challenge: codeChallenge,
                code_challenge_method: 'S256'
            });

            const authUrl = `https://twitter.com/i/oauth2/authorize?${params.toString()}`;
            console.log('üîó Auth URL:', authUrl);
            
            // Add a small delay and user notification
            showSuccess('Redirecting to Twitter... You should be redirected back here after login.');
            
            setTimeout(() => {
                window.location.href = authUrl;
            }, 1000);
        }

        // Handle OAuth callback
        async function handleOAuthCallback(code, state) {
            try {
                const storedState = localStorage.getItem('oauth_state');
                if (state !== storedState) {
                    throw new Error('State mismatch - possible CSRF attack');
                }

                const codeVerifier = localStorage.getItem('pkce_code_verifier');
                if (!codeVerifier) {
                    throw new Error('Code verifier not found');
                }

                console.log('üîÑ Attempting token exchange...');

                // Try multiple token exchange methods
                let tokenData = null;
                
                // Method 1: Try Vercel function if available
                if (USE_VERCEL_FUNCTION) {
                    try {
                        console.log('üöÄ Trying Vercel function...');
                        tokenData = await exchangeTokenWithVercel(code, codeVerifier);
                    } catch (error) {
                        console.log('‚ùå Vercel function failed:', error.message);
                    }
                }
                
                // Method 2: Try direct request (will likely fail due to CORS)
                if (!tokenData) {
                    try {
                        console.log('üß™ Trying direct token exchange...');
                        tokenData = await exchangeTokenDirect(code, codeVerifier);
                    } catch (error) {
                        console.log('‚ùå Direct exchange failed (expected):', error.message);
                    }
                }

                // Method 3: Try with CORS proxy (backup)
                if (!tokenData) {
                    try {
                        console.log('üß™ Trying CORS proxy...');
                        tokenData = await exchangeTokenWithProxy(code, codeVerifier);
                    } catch (error) {
                        console.log('‚ùå CORS proxy failed:', error.message);
                    }
                }

                // Method 4: Show manual token setup if automated methods fail
                if (!tokenData) {
                    console.log('‚ö†Ô∏è Automated token exchange failed, showing manual setup...');
                    showManualTokenSetup(code, codeVerifier);
                    return;
                }

                accessToken = tokenData.access_token;

                // Store token
                localStorage.setItem('twitter_access_token', accessToken);

                // Clean up URL and storage
                window.history.replaceState({}, document.title, window.location.pathname);
                localStorage.removeItem('pkce_code_verifier');
                localStorage.removeItem('oauth_state');

                // Show main app
                showMainApp();
                await loadUserInfo();
                await loadMyTweets();

            } catch (error) {
                console.error('OAuth callback error:', error);
                showError(`Authentication failed: ${error.message}`);
                
                // If it's a fetch error, provide specific help
                if (error.message.includes('Failed to fetch')) {
                    showCorsHelp();
                }
                
                logout();
            }
        }

        // Token exchange with Vercel function
        async function exchangeTokenWithVercel(code, codeVerifier) {
            const functionUrl = VERCEL_FUNCTION_URL.startsWith('http') ? 
                VERCEL_FUNCTION_URL : 
                window.location.origin + VERCEL_FUNCTION_URL;
                
            console.log('üì° Calling Vercel function:', functionUrl);
            
            const requestBody = {
                code: code,
                codeVerifier: codeVerifier,
                clientId: CLIENT_ID,
                redirectUri: REDIRECT_URI
            };

            // Add client secret if available (for confidential clients)
            if (CLIENT_SECRET && CLIENT_SECRET !== 'YOUR_TWITTER_CLIENT_SECRET') {
                requestBody.clientSecret = CLIENT_SECRET;
                console.log('üîê Using confidential client mode');
            } else {
                console.log('üîì Using public client mode (PKCE only)');
            }
            
            const response = await fetch(functionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.text();
                throw new Error(`Vercel function failed: ${errorData}`);
            }

            return await response.json();
        }

        // Direct token exchange (will likely fail due to CORS)
        async function exchangeTokenDirect(code, codeVerifier) {
            const response = await fetch('https://api.twitter.com/2/oauth2/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    grant_type: 'authorization_code',
                    client_id: CLIENT_ID,
                    code: code,
                    redirect_uri: REDIRECT_URI,
                    code_verifier: codeVerifier
                })
            });

            if (!response.ok) {
                const errorData = await response.text();
                throw new Error(`Token exchange failed: ${errorData}`);
            }

            return await response.json();
        }

        // Token exchange with CORS proxy
        async function exchangeTokenWithProxy(code, codeVerifier) {
            const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
            const tokenUrl = 'https://api.twitter.com/2/oauth2/token';
            
            const response = await fetch(proxyUrl + tokenUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams({
                    grant_type: 'authorization_code',
                    client_id: CLIENT_ID,
                    code: code,
                    redirect_uri: REDIRECT_URI,
                    code_verifier: codeVerifier
                })
            });

            if (!response.ok) {
                const errorData = await response.text();
                throw new Error(`Proxy token exchange failed: ${errorData}`);
            }

            return await response.json();
        }

        // Show main application
        function showMainApp() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'grid';
        }

        // Load current user info
        async function loadUserInfo() {
            try {
                console.log('üë§ Loading user info...');
                
                const response = await fetch('/api/user-info', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`User info request failed: ${response.status} - ${errorText}`);
                }

                const userData = await response.json();
                currentUser = userData.data;

                console.log('‚úÖ User data loaded:', currentUser);

                // Update UI
                document.getElementById('userAvatar').src = currentUser.profile_image_url || '';
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userHandle').textContent = `@${currentUser.username}`;
                document.getElementById('followersCount').textContent = currentUser.public_metrics.followers_count.toLocaleString();
                document.getElementById('followingCount').textContent = currentUser.public_metrics.following_count.toLocaleString();
                document.getElementById('tweetsCount').textContent = currentUser.public_metrics.tweet_count.toLocaleString();

            } catch (error) {
                console.error('Error loading user info:', error);
                showError('Failed to load user information: ' + error.message);
            }
        }

        // Load user's tweets
        async function loadMyTweets() {
            try {
                const tweetsContainer = document.getElementById('tweetsContainer');
                tweetsContainer.innerHTML = '<p class="loading">Loading your tweets...</p>';

                const response = await fetch(`https://api.twitter.com/2/users/${currentUser.id}/tweets?max_results=10&tweet.fields=created_at,public_metrics,context_annotations`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to load tweets: ${response.status}`);
                }

                const tweetsData = await response.json();
                displayTweets(tweetsData.data || []);

            } catch (error) {
                console.error('Error loading tweets:', error);
                showError('Failed to load tweets');
                document.getElementById('tweetsContainer').innerHTML = '<p class="error">Failed to load tweets</p>';
            }
        }

        // Display tweets
        function displayTweets(tweets) {
            const tweetsContainer = document.getElementById('tweetsContainer');
            
            if (!tweets.length) {
                tweetsContainer.innerHTML = '<p>No tweets found.</p>';
                return;
            }

            tweetsContainer.innerHTML = tweets.map(tweet => `
                <div class="post-item" onclick="selectTweet('${tweet.id}', this)">
                    <div class="post-content">${tweet.text}</div>
                    <div class="post-meta">
                        <span>üìÖ ${new Date(tweet.created_at).toLocaleString()}</span>
                        <span>‚ù§Ô∏è ${tweet.public_metrics?.like_count || 0}</span>
                        <span>üîÑ ${tweet.public_metrics?.retweet_count || 0}</span>
                        <span>üí¨ ${tweet.public_metrics?.reply_count || 0}</span>
                    </div>
                </div>
            `).join('');
        }

        // Select a tweet and load its replies
        async function selectTweet(tweetId, element) {
            // Remove previous selection
            document.querySelectorAll('.post-item').forEach(item => item.classList.remove('selected'));
            element.classList.add('selected');
            
            selectedTweet = tweetId;
            await loadReplies(tweetId);
        }

        // Load replies to a tweet
        async function loadReplies(tweetId) {
            try {
                if (!currentUser) {
                    console.log('‚ö†Ô∏è Current user not loaded yet, waiting...');
                    await loadUserInfo();
                }

                if (!currentUser) {
                    throw new Error('Failed to load user information');
                }

                const commentsContainer = document.getElementById('commentsContainer');
                const commentsSection = document.getElementById('commentsSection');
                
                commentsSection.style.display = 'block';
                commentsContainer.innerHTML = '<p class="loading">Loading replies...</p>';

                console.log('üí¨ Loading replies...');

                const response = await fetch(`/api/tweet-replies?tweetId=${tweetId}&username=${currentUser.username}`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Replies request failed: ${response.status} - ${errorText}`);
                }

                const repliesData = await response.json();

                console.log('‚úÖ Replies data loaded:', repliesData);
                displayReplies(repliesData.data || []);

            } catch (error) {
                console.error('Error loading replies:', error);
                showError('Failed to load replies: ' + error.message);
                document.getElementById('commentsContainer').innerHTML = '<p class="error">Failed to load replies</p>';
            }
        }

        // Display replies
        function displayReplies(replies) {
            const commentsContainer = document.getElementById('commentsContainer');
            
            if (!replies.length) {
                commentsContainer.innerHTML = '<p>No replies found for this tweet.</p>';
                return;
            }

            commentsContainer.innerHTML = replies.map(reply => `
                <div class="comment-item" onclick="selectComment('${reply.id}', this, '${reply.text.replace(/'/g, "\\'")}')">
                    <div class="comment-content">${reply.text}</div>
                    <div class="comment-meta">
                        <span>üìÖ ${new Date(reply.created_at).toLocaleString()}</span>
                        <span>‚ù§Ô∏è ${reply.public_metrics?.like_count || 0}</span>
                        <span>üí¨ ${reply.public_metrics?.reply_count || 0}</span>
                    </div>
                </div>
            `).join('');
        }

        // Select a comment for AI response
        function selectComment(commentId, element, commentText) {
            document.querySelectorAll('.comment-item').forEach(item => item.classList.remove('selected'));
            element.classList.add('selected');
            
            selectedComment = {
                id: commentId,
                text: commentText
            };
            
            document.getElementById('responseSection').style.display = 'block';
            generateResponse();
        }

        // Generate AI response
        async function generateResponse() {
            if (!selectedComment) {
                showError('Please select a comment first');
                return;
            }

            if (!deepseekApiKey) {
                showError('Please configure your Deepseek API key');
                return;
            }

            const responseTextarea = document.getElementById('generatedResponse');
            const instructions = document.getElementById('responseInstructions').value;
            const style = document.getElementById('responseStyle').value;
            
            responseTextarea.value = 'Generating AI response...';

            try {
                let systemPrompt = instructions;
                
                // Add style-specific instructions
                switch(style) {
                    case 'professional':
                        systemPrompt += ' Use a professional and respectful tone.';
                        break;
                    case 'casual':
                        systemPrompt += ' Use a casual and friendly tone with appropriate emojis.';
                        break;
                    case 'helpful':
                        systemPrompt += ' Focus on being helpful and providing useful information.';
                        break;
                    case 'engaging':
                        systemPrompt += ' Ask engaging questions to continue the conversation.';
                        break;
                }

                const response = await fetch(DEEPSEEK_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${deepseekApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: systemPrompt
                            },
                            {
                                role: 'user',
                                content: `Please respond to this comment: "${selectedComment.text}"`
                            }
                        ],
                        max_tokens: 100,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`AI API failed: ${response.status}`);
                }

                const data = await response.json();
                const generatedText = data.choices[0].message.content;
                
                responseTextarea.value = generatedText;
                showSuccess('AI response generated successfully!');

            } catch (error) {
                console.error('Error generating response:', error);
                showError(`Failed to generate response: ${error.message}`);
                responseTextarea.value = 'Failed to generate response. Please try again.';
            }
        }

        // Publish reply
        async function publishReply() {
            if (!selectedComment) {
                showError('Please select a comment first');
                return;
            }

            const responseText = document.getElementById('generatedResponse').value;
            
            if (!responseText || responseText === 'Generating AI response...') {
                showError('Please generate a response first');
                return;
            }

            if (!confirm('Are you sure you want to post this reply?')) {
                return;
            }

            try {
                console.log('üì§ Publishing reply...');
                
                const response = await fetch('/api/post-tweet', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: responseText,
                        replyToTweetId: selectedComment.id
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Post reply failed: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                
                console.log('‚úÖ Reply published:', data);
                showSuccess('Reply posted successfully!');
                
                // Clear the response area
                document.getElementById('generatedResponse').value = '';
                document.getElementById('responseSection').style.display = 'none';
                
                // Reload replies
                if (selectedTweet) {
                    await loadReplies(selectedTweet);
                }

            } catch (error) {
                console.error('Error posting reply:', error);
                showError(`Failed to post reply: ${error.message}`);
            }
        }

        // Show analytics (placeholder)
        function showAnalytics() {
            alert('Analytics feature coming soon! This will show your engagement stats and AI response performance.');
        }

        // Logout
        function logout() {
            localStorage.removeItem('twitter_access_token');
            localStorage.removeItem('deepseek_api_key');
            accessToken = '';
            currentUser = null;
            
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            
            // Clear form
            document.getElementById('deepseekApiKey').value = '';
        }

        // Show setup instructions
        function showSetupInstructions() {
            const currentUrl = window.location.href;
            const redirectUri = REDIRECT_URI;
            
            const instructions = `üîß TWITTER APP SETUP REQUIRED:

üìç IMPORTANT: Your redirect URI must be EXACTLY:
${redirectUri}

üèÉ‚Äç‚ôÇÔ∏è QUICK SETUP STEPS:

1Ô∏è‚É£ Go to: https://developer.twitter.com/en/portal/dashboard

2Ô∏è‚É£ Create new app (if you don't have one):
   - Click "Create App"
   - Fill in basic info
   - Click "Next"

3Ô∏è‚É£ Configure OAuth 2.0:
   - Go to your app settings
   - Click "App permissions" ‚Üí Set to "Read and write"
   - Click "Keys and tokens"
   - Find "OAuth 2.0 Client ID and Client Secret" section
   - Copy your Client ID AND Client Secret

4Ô∏è‚É£ Configure App Type:
   - In app settings, find "App info"
   - Set "App type" to "Confidential" (recommended)
   - OR set to "Public" if you prefer PKCE-only

5Ô∏è‚É£ Set Redirect URI:
   - Still in app settings
   - Click "App settings" 
   - Scroll to "Callback / Redirect URIs"
   - Add EXACTLY: ${redirectUri}
   - Save changes

6Ô∏è‚É£ Update this code:
   - Replace 'YOUR_TWITTER_CLIENT_ID' with your actual Client ID
   - Replace 'YOUR_TWITTER_CLIENT_SECRET' with your actual Client Secret
   - Redeploy to Vercel

‚ùå COMMON MISTAKES:
- Redirect URI doesn't match exactly (case-sensitive!)
- App permissions not set to "Read and write"
- Using wrong Client ID/Secret (use OAuth 2.0, not API key)
- App type doesn't match authentication method
- Forgetting the trailing slash in redirect URI

üîç DEBUGGING:
- Check browser console for error messages
- Make sure redirect URI in Twitter app matches exactly: ${redirectUri}
- Ensure OAuth 2.0 is enabled (not OAuth 1.0a)
- For 401 errors: Check app type (Confidential vs Public)`;

            console.log(instructions);
            
            // Show in modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; 
                display: flex; align-items: center; justify-content: center; padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; padding: 30px; border-radius: 15px; 
                max-width: 700px; max-height: 80%; overflow-y: auto;
                font-family: monospace; white-space: pre-line; font-size: 13px;
            `;
            content.textContent = instructions;
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close & Check Console';
            closeBtn.style.cssText = 'margin-top: 20px; padding: 10px 20px; background: #1da1f2; color: white; border: none; border-radius: 5px; cursor: pointer;';
            closeBtn.onclick = () => modal.remove();
            
            content.appendChild(closeBtn);
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // Show CORS help
        function showCorsHelp() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; 
                display: flex; align-items: center; justify-content: center; padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; padding: 30px; border-radius: 15px; 
                max-width: 700px; max-height: 80%; overflow-y: auto;
                font-family: Arial; line-height: 1.6;
            `;
            
            content.innerHTML = `
                <h2 style="color: #1da1f2; margin-bottom: 20px;">üö´ CORS Issue Detected</h2>
                
                <p><strong>What happened:</strong> Your OAuth login worked, but the token exchange is blocked by CORS policy. This is normal for client-side apps.</p>
                
                <h3 style="margin: 20px 0 10px 0;">üîß Solutions (Choose One):</h3>
                
                <div style="border: 2px solid #28a745; padding: 15px; margin: 15px 0; border-radius: 10px;">
                    <h4 style="color: #28a745;">‚úÖ SOLUTION 1: Deploy with Vercel (Recommended)</h4>
                    <p>Vercel provides serverless functions that can handle the token exchange:</p>
                    <ol>
                        <li>Push your code to GitHub</li>
                        <li>Connect your repo to <a href="https://vercel.com" target="_blank">Vercel.com</a></li>
                        <li>Add the serverless function (I'll provide the code)</li>
                        <li>Update your redirect URI to the Vercel URL</li>
                        <li>Set USE_VERCEL_FUNCTION = true in your code</li>
                    </ol>
                    <button onclick="showVercelInstructions()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                        üìã Show Vercel Setup Guide
                    </button>
                </div>
                
                <div style="border: 2px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 10px;">
                    <h4 style="color: #e0a800;">‚ö° SOLUTION 2: Use Browser Extension</h4>
                    <p>Install a CORS extension temporarily:</p>
                    <ol>
                        <li>Install "CORS Unblock" extension</li>
                        <li>Enable it for your GitHub Pages site</li>
                        <li>Refresh the page and try login again</li>
                    </ol>
                </div>
                
                <div style="border: 2px solid #17a2b8; padding: 15px; margin: 15px 0; border-radius: 10px;">
                    <h4 style="color: #17a2b8;">üîß SOLUTION 3: Manual Token Setup</h4>
                    <p>Get the token manually and paste it in:</p>
                    <button onclick="showManualTokenInstructions()" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        Show Manual Instructions
                    </button>
                </div>
                
                <button onclick="this.closest('div').remove()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 20px;">
                    Close
                </button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // Show manual token setup
        function showManualTokenSetup(code, codeVerifier) {
            console.log('üìã Manual token setup data:');
            console.log('Code:', code);
            console.log('Code Verifier:', codeVerifier);
            console.log('Client ID:', CLIENT_ID);
            console.log('Redirect URI:', REDIRECT_URI);
            
            showCorsHelp();
        }

        // Show manual token instructions
        function showManualTokenInstructions() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const codeVerifier = localStorage.getItem('pkce_code_verifier');
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.9); z-index: 11000; 
                display: flex; align-items: center; justify-content: center; padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; padding: 30px; border-radius: 15px; 
                max-width: 800px; max-height: 90%; overflow-y: auto;
                font-family: monospace; font-size: 12px;
            `;
            
            content.innerHTML = `
                <h2>üîß Manual Token Exchange</h2>
                <p>Use this curl command to get your access token:</p>
                
                <textarea readonly style="width: 100%; height: 150px; margin: 10px 0; padding: 10px; border: 1px solid #ccc;">curl -X POST https://api.twitter.com/2/oauth2/token \\
  -H "Content-Type: application/x-www-form-urlencoded" \\
  -d "grant_type=authorization_code" \\
  -d "client_id=${CLIENT_ID}" \\
  -d "code=${code}" \\
  -d "redirect_uri=${encodeURIComponent(REDIRECT_URI)}" \\
  -d "code_verifier=${codeVerifier}"</textarea>
  
                <p><strong>Steps:</strong></p>
                <ol>
                    <li>Copy the curl command above</li>
                    <li>Run it in terminal/command prompt</li>
                    <li>Copy the "access_token" from the response</li>
                    <li>Paste it in the input below:</li>
                </ol>
                
                <input type="text" id="manualToken" placeholder="Paste access token here..." style="width: 100%; padding: 10px; margin: 10px 0;">
                
                <div style="margin: 20px 0;">
                    <button onclick="useManualToken()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                        Use This Token
                    </button>
                    <button onclick="this.closest('div').remove()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        Cancel
                    </button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // Show Vercel instructions
        function showVercelInstructions() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.9); z-index: 12000; 
                display: flex; align-items: center; justify-content: center; padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; padding: 30px; border-radius: 15px; 
                max-width: 800px; max-height: 90%; overflow-y: auto;
                font-family: Arial; line-height: 1.6;
            `;
            
            content.innerHTML = `
                <h2 style="color: #28a745; margin-bottom: 20px;">üöÄ Vercel Deployment Guide</h2>
                
                <h3>üìÅ Files You Need:</h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
                    <strong>1. api/twitter-token.js</strong> - The serverless function<br>
                    <strong>2. index.html</strong> - Your current HTML file<br>
                    <strong>3. Update configuration in HTML</strong>
                </div>
                
                <h3>üîß Steps:</h3>
                <ol style="margin-left: 20px;">
                    <li><strong>Create api folder</strong> in your GitHub repository</li>
                    <li><strong>Add twitter-token.js</strong> file with the serverless function code</li>
                    <li><strong>Update your HTML</strong>: Set <code>USE_VERCEL_FUNCTION = true</code></li>
                    <li><strong>Go to <a href="https://vercel.com" target="_blank">vercel.com</a></strong> and sign up with GitHub</li>
                    <li><strong>Import your repository</strong> and deploy</li>
                    <li><strong>Update Twitter app</strong> redirect URI to Vercel URL</li>
                </ol>
                
                <div style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin: 15px 0;">
                    <strong>üí° Result:</strong> Your app will work perfectly with no CORS issues!
                </div>
                
                <div style="margin: 20px 0;">
                    <button onclick="window.open('https://github.com/new', '_blank')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                        üìÅ Create GitHub Repo
                    </button>
                    <button onclick="window.open('https://vercel.com', '_blank')" style="background: #000; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                        üöÄ Open Vercel
                    </button>
                    <button onclick="this.closest('div').remove()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        Close
                    </button>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0;">
                    <strong>üìã Need the serverless function code?</strong><br>
                    Check the "Vercel Serverless Function" artifact I created above.
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // Use manual token
        function useManualToken() {
            const token = document.getElementById('manualToken').value.trim();
            if (!token) {
                alert('Please paste your access token');
                return;
            }
            
            accessToken = token;
            localStorage.setItem('twitter_access_token', accessToken);
            
            // Clean up
            document.querySelectorAll('div[style*="position: fixed"]').forEach(modal => modal.remove());
            window.history.replaceState({}, document.title, window.location.pathname);
            localStorage.removeItem('pkce_code_verifier');
            localStorage.removeItem('oauth_state');
            
            // Show main app
            showMainApp();
            loadUserInfo();
            loadMyTweets();
        }
        function checkCurrentUrl() {
            const info = `üîç CURRENT URL DEBUG INFO:

üåê Full URL: ${window.location.href}
üè† Origin: ${window.location.origin}
üìÑ Pathname: ${window.location.pathname}
üîó Redirect URI: ${REDIRECT_URI}

üìã URL Parameters:
${window.location.search ? window.location.search : 'None'}

‚úÖ This is what should be set in your Twitter app as the redirect URI:
${REDIRECT_URI}

üí° Make sure it matches EXACTLY in your Twitter app settings!`;

            console.log(info);
            alert(info);
        }

        function testRedirect() {
            if (!CLIENT_ID || CLIENT_ID === 'YOUR_TWITTER_CLIENT_ID') {
                alert('‚ö†Ô∏è Please set your CLIENT_ID first!\n\nReplace YOUR_TWITTER_CLIENT_ID in the code with your actual Twitter OAuth 2.0 Client ID.');
                return;
            }

            const testUrl = `https://twitter.com/i/oauth2/authorize?response_type=code&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=tweet.read&state=test123&code_challenge=test&code_challenge_method=S256`;
            
            console.log('üß™ Test URL:', testUrl);
            
            if (confirm(`üß™ TEST REDIRECT URI\n\nThis will open Twitter OAuth with your settings.\nYou should be redirected back here after login.\n\nCurrent redirect URI: ${REDIRECT_URI}\n\nContinue?`)) {
                window.open(testUrl, '_blank');
            }
        }
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            const container = document.querySelector('.content-area') || document.querySelector('.auth-section');
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            
            const container = document.querySelector('.content-area') || document.querySelector('.auth-section');
            container.insertBefore(successDiv, container.firstChild);
            
            setTimeout(() => successDiv.remove(), 3000);
        }
    </script>
</body>
</html>
